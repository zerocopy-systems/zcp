name: CI

on:
  push:
    branches: [main]
    tags: ["v*"]
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets -- -W clippy::all

      - name: Build
        run: cargo build --release

      - name: Run tests
        run: cargo test --all-features

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Generate Cargo.lock
        run: cargo generate-lockfile

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Security audit
        # Note: Many advisories are from transitive deps in ethers, indicatif, aws-nitro-enclaves-nsm-api
        # Our direct deps are clean. Run in informational mode to not block CI.
        continue-on-error: true
        run: cargo audit 2>&1 | tee audit-results.txt || echo "Advisories found (see log above)"

      - name: Check for critical advisories
        run: |
          # Fail only if we find actual vulnerability (not unmaintained warnings)
          if grep -E "Vulnerability|vulnerability" audit-results.txt; then
            echo "::warning::Security vulnerabilities found - review required"
          else
            echo "No critical vulnerabilities (some unmaintained warnings may exist)"
          fi

  release:
    name: Build Release Binaries
    if: startsWith(github.ref, 'refs/tags/')
    needs: [test, security]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: zcp-linux-x86_64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact: zcp-linux-arm64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: zcp-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: zcp-macos-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (ARM Linux)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Package
        run: |
          cp target/${{ matrix.target }}/release/zcp ${{ matrix.artifact }}
          sha256sum ${{ matrix.artifact }} > ${{ matrix.artifact }}.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            ${{ matrix.artifact }}
            ${{ matrix.artifact }}.sha256

  publish:
    name: Publish Release
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign binaries with Cosign (Keyless)
        run: |
          for binary in artifacts/*/zcp-*; do
            if [[ ! "$binary" == *.sha256 ]]; then
              echo "Signing $binary..."
              cosign sign-blob --yes "$binary" --output-signature "${binary}.sig" --output-certificate "${binary}.pem"
            fi
          done

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          for dir in artifacts/*/; do
            for file in "$dir"*; do
              if [[ -f "$file" ]]; then
                cp "$file" release-assets/
              fi
            done
          done
          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*
          generate_release_notes: true
          body: |
            ## ZCP Audit CLI ${{ github.ref_name }}

            ### Installation

            **Homebrew (macOS/Linux):**
            ```bash
            brew install zerocopy-systems/tap/zcp
            ```

            **One-Line Install:**
            ```bash
            curl -sSL https://raw.githubusercontent.com/zerocopy-systems/zcp/main/install.sh | sh
            ```

            **Cargo (from source):**
            ```bash
            cargo install zerocopy-audit
            ```

            ### Verify Signatures (Cosign)
            ```bash
            cosign verify-blob --signature zcp-linux-x86_64.sig --certificate zcp-linux-x86_64.pem zcp-linux-x86_64
            ```

            ### Quick Start
            ```bash
            zcp audit --volume 10000000 --explain
            ```

  crates-publish:
    name: Publish to crates.io
    needs: [test, security]
    if: startsWith(github.ref, 'refs/tags/')
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Publish
        run: cargo publish --no-verify
        env:
          CARGO_REGISTRY_TOKEN: ${{ secrets.CARGO_REGISTRY_TOKEN }}

  homebrew-update:
    name: Update Homebrew Formula
    needs: publish
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Download release artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Compute SHA256 checksums
        id: sha
        run: |
          for target in macos-arm64 macos-x86_64 linux-arm64 linux-x86_64; do
            sha=$(cat artifacts/zcp-${target}/zcp-${target}.sha256 | awk '{print $1}')
            key=$(echo "$target" | tr '-' '_')
            echo "${key}=${sha}" >> "$GITHUB_OUTPUT"
          done

      - name: Update formula and push to homebrew-tap
        env:
          GH_TOKEN: ${{ secrets.HOMEBREW_TAP_TOKEN }}
        run: |
          VERSION="${GITHUB_REF_NAME#v}"

          # Clone the tap repo (will be created if first release)
          git clone https://x-access-token:${GH_TOKEN}@github.com/zerocopy-systems/homebrew-tap.git tap || {
            mkdir -p tap/Formula
            cd tap && git init && git remote add origin https://x-access-token:${GH_TOKEN}@github.com/zerocopy-systems/homebrew-tap.git
            cd ..
          }

          # Generate formula from template
          cat > tap/Formula/zcp.rb << 'FORMULA_EOF'
          # typed: false
          # frozen_string_literal: true

          class Zcp < Formula
            desc "HFT infrastructure latency audit tool â€” quantify your signing Jitter Tax"
            homepage "https://zerocopy.systems"
            version "VERSION_PLACEHOLDER"
            license "MIT"

            on_macos do
              on_arm do
                url "https://github.com/zerocopy-systems/zcp/releases/download/vVERSION_PLACEHOLDER/zcp-macos-arm64"
                sha256 "SHA_MACOS_ARM64"
              end
              on_intel do
                url "https://github.com/zerocopy-systems/zcp/releases/download/vVERSION_PLACEHOLDER/zcp-macos-x86_64"
                sha256 "SHA_MACOS_X86_64"
              end
            end

            on_linux do
              on_arm do
                url "https://github.com/zerocopy-systems/zcp/releases/download/vVERSION_PLACEHOLDER/zcp-linux-arm64"
                sha256 "SHA_LINUX_ARM64"
              end
              on_intel do
                url "https://github.com/zerocopy-systems/zcp/releases/download/vVERSION_PLACEHOLDER/zcp-linux-x86_64"
                sha256 "SHA_LINUX_X86_64"
              end
            end

            def install
              binary = Dir["zcp-*"].first || "zcp"
              bin.install binary => "zcp"
            end

            test do
              assert_match "zerocopy-audit", shell_output("#{bin}/zcp --version")
            end
          end
          FORMULA_EOF

          # Replace placeholders with real values
          sed -i "s/VERSION_PLACEHOLDER/${VERSION}/g" tap/Formula/zcp.rb
          sed -i "s/SHA_MACOS_ARM64/${{ steps.sha.outputs.macos_arm64 }}/g" tap/Formula/zcp.rb
          sed -i "s/SHA_MACOS_X86_64/${{ steps.sha.outputs.macos_x86_64 }}/g" tap/Formula/zcp.rb
          sed -i "s/SHA_LINUX_ARM64/${{ steps.sha.outputs.linux_arm64 }}/g" tap/Formula/zcp.rb
          sed -i "s/SHA_LINUX_X86_64/${{ steps.sha.outputs.linux_x86_64 }}/g" tap/Formula/zcp.rb

          # Commit and push
          cd tap
          git config user.name "ZeroCopy Release Bot"
          git config user.email "engineering@zerocopy.systems"
          git add Formula/zcp.rb
          git commit -m "zcp ${VERSION}" || echo "No changes"
          git push origin main || git push --set-upstream origin main

