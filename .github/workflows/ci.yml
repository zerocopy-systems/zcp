name: CI

on:
  push:
    branches: [main]
    tags: ['v*']
  pull_request:
    branches: [main]

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  test:
    name: Test Suite
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          components: rustfmt, clippy

      - name: Cache cargo
        uses: actions/cache@v4
        with:
          path: |
            ~/.cargo/bin/
            ~/.cargo/registry/index/
            ~/.cargo/registry/cache/
            ~/.cargo/git/db/
            target/
          key: ${{ runner.os }}-cargo-${{ hashFiles('**/Cargo.lock') }}

      - name: Check formatting
        run: cargo fmt --all -- --check

      - name: Clippy
        run: cargo clippy --all-targets -- -W clippy::all

      - name: Build
        run: cargo build --release

      - name: Run tests
        run: cargo test --all-features

  security:
    name: Security Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Generate Cargo.lock
        run: cargo generate-lockfile

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Security audit
        run: |
          # Ignore advisories from transitive dependencies we can't control:
          # ethers 2.0.x uses older deps (reqwest 0.11, ring 0.16, rustls-pemfile 1.x)
          # aws-nitro-enclaves-nsm-api uses serde_cbor
          # indicatif uses number_prefix
          cargo audit \
            --ignore RUSTSEC-2024-0409 \
            --ignore RUSTSEC-2021-0127 \
            --ignore RUSTSEC-2025-0010 \
            --ignore RUSTSEC-2025-0119 \
            --ignore RUSTSEC-2025-0134

  release:
    name: Build Release Binaries
    if: startsWith(github.ref, 'refs/tags/')
    needs: [test, security]
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            artifact: zcp-linux-x86_64
          - os: ubuntu-latest
            target: aarch64-unknown-linux-gnu
            artifact: zcp-linux-arm64
          - os: macos-latest
            target: x86_64-apple-darwin
            artifact: zcp-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            artifact: zcp-macos-arm64

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Install cross-compilation tools (ARM Linux)
        if: matrix.target == 'aarch64-unknown-linux-gnu'
        run: |
          sudo apt-get update
          sudo apt-get install -y gcc-aarch64-linux-gnu

      - name: Build
        run: cargo build --release --target ${{ matrix.target }}
        env:
          CARGO_TARGET_AARCH64_UNKNOWN_LINUX_GNU_LINKER: aarch64-linux-gnu-gcc

      - name: Package
        run: |
          cp target/${{ matrix.target }}/release/zcp ${{ matrix.artifact }}
          sha256sum ${{ matrix.artifact }} > ${{ matrix.artifact }}.sha256

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.artifact }}
          path: |
            ${{ matrix.artifact }}
            ${{ matrix.artifact }}.sha256

  publish:
    name: Publish Release
    needs: release
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Install Cosign
        uses: sigstore/cosign-installer@v3

      - name: Sign binaries with Cosign (Keyless)
        run: |
          for binary in artifacts/*/zcp-*; do
            if [[ ! "$binary" == *.sha256 ]]; then
              echo "Signing $binary..."
              cosign sign-blob --yes "$binary" --output-signature "${binary}.sig" --output-certificate "${binary}.pem"
            fi
          done

      - name: Prepare release assets
        run: |
          mkdir -p release-assets
          for dir in artifacts/*/; do
            for file in "$dir"*; do
              if [[ -f "$file" ]]; then
                cp "$file" release-assets/
              fi
            done
          done
          ls -la release-assets/

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          files: release-assets/*
          generate_release_notes: true
          body: |
            ## ZCP Audit CLI ${{ github.ref_name }}
            
            ### Installation
            ```bash
            curl -sSL https://zerocopy.systems/install | sh
            ```
            
            ### Verify Signatures (Cosign)
            ```bash
            cosign verify-blob --signature zcp-linux-x86_64.sig --certificate zcp-linux-x86_64.pem zcp-linux-x86_64
            ```
            
            ### Quick Start
            ```bash
            zcp audit --volume 10000000 --explain
            ```
